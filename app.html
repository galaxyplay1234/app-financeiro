<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Minhas FinanÃ§as</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="theme-color" content="#1976d2">

<style>
*{box-sizing:border-box;font-family:Arial,sans-serif}
body{
  margin:0;
  background:#f4f6f8;
  overflow-x:hidden;
}


.top-fixed{
  position:sticky;
  top:0;
  z-index:20;
  background:#f4f6f8;
}

/* HEADER */
header{
  background:#1976d2;
  color:#fff;
  padding:12px;
  display:flex;
  flex-direction:column;
  align-items:flex-start;
}

header h2{
  margin:0;
  font-size:18px;
  font-weight:600;
}

.cat-btn{
  background:transparent;
  border:none;
  color:#fff;
  font-size:22px;
  cursor:pointer;
  padding:4px 6px;
}
.cat-btn:active{opacity:.6}

.month-tabs{
  width:100%;
  display:flex;
  justify-content:center;
  align-items:center;
  gap:14px;
  margin-top:6px;
}

.month-btn{
  background:transparent;
  border:none;
  color:#fff;
  font-size:22px;
  cursor:pointer;
  padding:4px 6px;
}

.month-btn:active{opacity:.6}

#monthLabel{
  font-size:14px;
  font-weight:500;
  min-width:140px;
  text-align:center;
}

.cards{
  display:flex;
  gap:10px;
  padding:10px;
}
.card{
  flex:1;background:#fff;padding:12px;border-radius:10px;
  text-align:center;box-shadow:0 2px 6px rgba(0,0,0,.1)
}
.card h4{margin:0;font-size:14px;color:#666}
.card .main{font-size:18px;font-weight:bold;margin-top:6px}
.card .sub{font-size:13px;color:#777}
.saldo{border-top:4px solid #1976d2}
.receita{border-top:4px solid #2e7d32}
.despesa{border-top:4px solid #c62828}

/* LISTA */
.list{padding:10px}
.row{display:flex;gap:8px;margin-bottom:8px;cursor:pointer}
.date-card{
  width:56px;height:64px;background:#fff;border-radius:10px;
  display:flex;align-items:center;justify-content:center;
  font-size:14px;font-weight:bold;color:#888;
  box-shadow:0 1px 4px rgba(0,0,0,.1)
}
.item{
  flex:1;background:#fff;padding:10px;border-radius:10px;
  border-left:5px solid #2196f3;
  box-shadow:0 1px 4px rgba(0,0,0,.1);
  height:64px;display:flex;flex-direction:column;justify-content:center
}
.item-top{display:flex;justify-content:space-between}
.item-name{font-weight:bold;font-size:14px}
.item-value{font-size:16px;font-weight:bold}
.income{color:#2e7d32}
.expense{color:#c62828}
.item-bottom{display:flex;justify-content:space-between;align-items:center}
.item-sub{font-size:12px;color:#666}
.badge{
  padding:2px 8px;font-size:12px;border-radius:12px;
  color:#fff;white-space:nowrap
}
.green{background:#2e7d32}
.red{background:#c62828}

/* FAB */
.fab{
  position:fixed;right:20px;bottom:20px;
  width:56px;height:56px;border-radius:50%;
  font-size:26px;background:#1976d2;color:#fff;border:none
}

/* MODAL */
.modal{
  display:none;
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.5);
  justify-content:center;
  align-items:center;
  z-index:9999; /* ðŸ‘ˆ ESSA LINHA resolve tudo */
}
.modal-content{
  background:#fff;width:90%;max-width:320px;
  padding:16px;border-radius:12px;
  font-size:16px
}

/* TYPE BUTTONS */
.type-buttons{display:flex;gap:8px;margin-bottom:8px}
/* BOTÃƒO PADRÃƒO (NÃƒO SELECIONADO) */
.type-btn{
  flex:1;
  padding:10px;
  border-radius:8px;

  /* visual que vocÃª pediu */
  background:#fff;              /* fundo branco */
  border:1px solid #ccc;        /* contorno cinza 1px */
  color:#777;                   /* texto cinza */

  font-weight:bold;
}

/* RECEITA SELECIONADA */
.type-btn.active.income{
  background:#2e7d32;
  color:#fff;
  border:none;
}

/* DESPESA SELECIONADA */
.type-btn.active.expense{
  background:#c62828;
  color:#fff;
  border:none;
}

/* INPUTS */
.modal-content input,
.modal-content select,
.modal-content button{
  width:100%;margin-top:8px;padding:10px;
  border-radius:8px;border:1px solid #ccc;
  font-size:16px
}

.modal-content input[type="date"]{
  width:100%;
  box-sizing:border-box;
  -webkit-appearance:none;
  appearance:none;
}


/* ===============================
   CORREÃ‡ÃƒO BOTÃ•ES RECEITA / DESPESA
   =============================== */

/* botÃ£o padrÃ£o (nÃ£o selecionado) */
.modal-content .type-btn{
  background:#fff !important;
  border:1px solid #ccc !important;
  color:#777 !important;
}

/* receita ativa */
.modal-content .type-btn.active.income{
  background:#2e7d32 !important;
  color:#fff !important;
  border:none !important;
}

/* despesa ativa */
.modal-content .type-btn.active.expense{
  background:#c62828 !important;
  color:#fff !important;
  border:none !important;
}


/* SWITCH */
.switch-row{
  display:flex;justify-content:space-between;
  align-items:center;margin-top:10px
}
.switch{position:relative;width:46px;height:26px}
.switch input{display:none}
.slider{
  position:absolute;inset:0;cursor:pointer;
  background:#ccc;border-radius:26px;transition:.3s
}
.slider:before{
  content:"";position:absolute;width:20px;height:20px;
  left:3px;top:3px;background:#fff;border-radius:50%;
  transition:.3s
}
input:checked + .slider{background:#2e7d32}
input:checked + .slider:before{transform:translateX(20px)}

/* BUTTONS */
.modal-content button{background:#1976d2;color:#fff;border:none}
.modal-content button.cancel{background:#9e9e9e}
.modal-content button.delete{background:#c62828}

/* ===============================
   PARCELAMENTO
=============================== */
.parcel-buttons{
  display:flex;
  gap:8px;
  margin-top:8px;
  align-items:center;
}

.parcel-btn{
  width:auto !important;
  background:#fff !important;
  color:#777 !important;
  border:1px solid #ccc !important;
  font-weight:bold; /* ðŸ‘ˆ AQUI resolve */
}

/* ATIVO */
.parcel-btn.active{
  border-color:#1976d2 !important;
  color:#1976d2 !important;
}




.category-item{
  display:flex;
  justify-content:space-between;
  align-items:center;
  background:#f4f6f8;
  padding:8px 10px;
  border-radius:8px;
  margin-top:6px;
  font-size:14px;
}

.category-item button{
  background:none;
  border:none;
  color:#c62828;
  font-size:16px;
  font-weight:bold;
  cursor:pointer;

  /* alinhamento perfeito */
  display:flex;
  align-items:center;
  justify-content:center;

  /* Ã¡rea de clique mÃ­nima */
  width:20px;
  height:20px;

  padding:0;
  line-height:1;
}

#categoryModal .modal-content{
  max-height:80vh;
  display:flex;
  flex-direction:column;
}

#categoryList{
  overflow-y:auto;
  max-height:260px;
}


/* itens agrupados por dia */
.item{
  border-radius:0;
  margin:0;
}

/* primeiro item do dia */
.item.first-of-day{
  border-top-left-radius:10px;
  border-top-right-radius:10px;
}

/* Ãºltimo item do dia */
.item.last-of-day{
  border-bottom-left-radius:10px;
  border-bottom-right-radius:10px;
}

/* remove espaÃ§o entre itens do mesmo dia */
.day-items{
  display:flex;
  flex-direction:column;
  gap:0;
}


/* ITEM ATRASADO */
.late-item{
  background: #fdecea; /* vermelho bem clarinho */
  border-left-color: #c62828; /* mantÃ©m coerÃªncia com despesa */
}

</style>
</head>

<body>

<div class="top-fixed">

  <header>
    <div style="width:100%;display:flex;justify-content:space-between;align-items:center">
  <h2>ðŸ’° Minhas FinanÃ§as</h2>

  <div style="display:flex;gap:10px">
  <button class="cat-btn" onclick="openCategoryModal()">â˜°</button>
  <button class="cat-btn" onclick="goReports()">ðŸ“Š</button>
</div>
</div>
    <div class="month-tabs">
      <button class="month-btn" onclick="changeMonth(-1)">&#10094;</button>
      <span id="monthLabel"></span>
      <button class="month-btn" onclick="changeMonth(1)">&#10095;</button>
    </div>
  </header>

  <section class="cards">
    <div class="card saldo">
      <h4>Saldo</h4>
      <div class="main" id="saldoPago">R$ 0,00</div>
      <div class="sub" id="saldoPrev">R$ 0,00</div>
    </div>

    <div class="card receita">
      <h4>Receitas</h4>
      <div class="main" id="recPago">R$ 0,00</div>
      <div class="sub" id="recPrev">R$ 0,00</div>
    </div>

    <div class="card despesa">
      <h4>Despesas</h4>
      <div class="main" id="despPago">R$ 0,00</div>
      <div class="sub" id="despPrev">R$ 0,00</div>
    </div>
  </section>

</div>

<section class="list" id="list"></section>

<button class="fab" onclick="openModal()">+</button>

<div class="modal" id="modal">
<div class="modal-content">

<div class="type-buttons">
  <button class="type-btn income active" onclick="setType('income')">Receita</button>
  <button class="type-btn expense" onclick="setType('expense')">Despesa</button>
</div>

<input id="title" placeholder="Nome">
<input id="value" placeholder="Valor">
<select id="category">
  <option>Geral</option>
  <option>AlimentaÃ§Ã£o</option>
  <option>Moradia</option>
  <option>Transporte</option>
</select>
<input id="date" type="date">
  
<!-- PARCELAMENTO -->
<div class="parcel-buttons">
  <button id="btnParcel" class="parcel-btn" onclick="toggleParcel()">
    Parcelado
  </button>

  <input
    id="parcelCount"
    type="number"
    min="2"
    placeholder="Meses"
    style="display:none; width:110px"
  >
</div>



<div class="switch-row">
  <span>Pago</span>
  <label class="switch">
    <input type="checkbox" id="paid">
    <span class="slider"></span>
  </label>
</div>

<button onclick="save()">Salvar</button>
<button id="deleteBtn" class="delete" onclick="remove()">Excluir</button>
<button class="cancel" onclick="closeModal()">Cancelar</button>

</div>
</div>

<div class="modal" id="categoryModal">
  <div class="modal-content">

    <h3 style="margin:0 0 10px 0">Categorias</h3>

    <input id="categoryName" placeholder="Nome da categoria">

    <button onclick="saveCategory()">Salvar</button>

    <div id="categoryList" style="margin-top:12px"></div>

    <button class="cancel" onclick="closeCategoryModal()">Fechar</button>

  </div>
</div>

<script>
let currentMonth = new Date();
let editId = null;
let editMonthKey = null;
let currentType = "income";
let editingParcelData = null;

const monthLabel = document.getElementById("monthLabel");
const modal = document.getElementById("modal");
const deleteBtn = document.getElementById("deleteBtn");
const valueInput = document.getElementById("value");

/* =========================
   UTIL
========================= */
valueInput.addEventListener("input",()=>{
  let v = valueInput.value.replace(/\D/g,"");
  v = (Number(v)/100).toLocaleString("pt-BR",{minimumFractionDigits:2});
  valueInput.value = v;
});

function updateMonthLabel(){
  const meses=["Janeiro","Fevereiro","MarÃ§o","Abril","Maio","Junho","Julho","Agosto","Setembro","Outubro","Novembro","Dezembro"];
  monthLabel.innerText = `${meses[currentMonth.getMonth()]} ${currentMonth.getFullYear()}`;
}

function getMonthKey(){
  return `${currentMonth.getFullYear()}-${String(currentMonth.getMonth()+1).padStart(2,"0")}`;
}

function formatDate(d){
  const [y,m,day]=d.split("-");
  return `${day}/${m}`;
}

/* =========================
   FIREBASE REFS
========================= */
function monthRef(){
  return firebase.database().ref("finance/meses/"+getMonthKey());
}

function categoriesRef(){
  return firebase.database().ref("finance/categorias");
}

/* =========================
   MÃŠS
========================= */
function changeMonth(step){
  currentMonth.setMonth(currentMonth.getMonth()+step);
  updateMonthLabel();
  render();
}

/* =========================
   TYPE
========================= */
function setType(t){
  currentType=t;
  document.querySelectorAll(".type-btn").forEach(b=>b.classList.remove("active"));
  document.querySelector(`.type-btn.${t}`).classList.add("active");
}


/* =========================
   PARCELAMENTO
========================= */
let isParcel = false;

function toggleParcel(){
  isParcel = !isParcel;

  const btn = document.getElementById("btnParcel");
  const input = document.getElementById("parcelCount");

  btn.classList.toggle("active", isParcel);
  input.style.display = isParcel ? "block" : "none";

  if(!isParcel){
    input.value = "";
  }
}


/* =========================
   RENDER
========================= */
function render(){
  const container = document.getElementById("list");
  container.innerHTML = "";

  let rPago = 0, rPrev = 0, dPago = 0, dPrev = 0;

  // remove listener antigo
  monthRef().off();

  monthRef().on("value", snap=>{
    const data = snap.val() || {};
    const list = Object.values(data)
      .sort((a,b)=>new Date(b.date)-new Date(a.date));

    container.innerHTML = "";

    // ==========================
    // AGRUPA POR DATA
    // ==========================
    const groupedByDate = {};

    list.forEach(t=>{
      if(!groupedByDate[t.date]){
        groupedByDate[t.date] = [];
      }
      groupedByDate[t.date].push(t);
    });

    // ==========================
    // RENDERIZA POR DIA
    // ==========================
    Object.keys(groupedByDate)
      .sort((a,b)=>new Date(b)-new Date(a))
      .forEach(date=>{

        const row = document.createElement("div");
        row.className = "row";

        // card da data
        const dateCard = document.createElement("div");
        dateCard.className = "date-card";
        dateCard.innerText = formatDate(date);

        // container dos itens do dia
        const itemsWrap = document.createElement("div");
        itemsWrap.className = "day-items";
        itemsWrap.style.flex = "1";

        groupedByDate[date]
  .sort((a, b) => b.value - a.value) // ðŸ”¥ MAIOR â†’ MENOR
  .forEach((t, index) => {

          // totais
          if(t.type==="income"){
            t.paid ? rPago+=t.value : rPrev+=t.value;
          }else{
            t.paid ? dPago+=t.value : dPrev+=t.value;
          }

          const today = new Date();
today.setHours(0,0,0,0);

const dueDate = new Date(t.date);
dueDate.setHours(0,0,0,0);

const late = !t.paid && dueDate < today;

          const item = document.createElement("div");
item.className = "item";

if(late){
  item.classList.add("late-item");
}

          // bordas corretas
          if(index === 0){
            item.classList.add("first-of-day");
          }
          if(index === groupedByDate[date].length - 1){
            item.classList.add("last-of-day");
          }

          item.onclick = () => editById(t.id);

          item.innerHTML = `
            <div class="item-top">
              <div class="item-name">${t.name}</div>
              <div class="item-value ${t.type}">
                R$ ${t.value.toLocaleString("pt-BR",{minimumFractionDigits:2})}
              </div>
            </div>
            <div class="item-bottom">
              <div class="item-sub">
  ${t.category}
  ${
    t.parcel
  ? `<span style="margin-left:6px;font-size:12px;color:#777">
       ${t.parcelIndex}/${t.parcelTotal}
     </span>`
  : ""
  }
</div>
              ${
                t.paid
                  ? `<div class="badge green">${t.type==="income"?"Recebido":"Pago"}</div>`
                  : late
                    ? `<div class="badge red">Atrasado</div>`
                    : ""
              }
            </div>
          `;

          itemsWrap.appendChild(item);
        });

        row.appendChild(dateCard);
        row.appendChild(itemsWrap);
        container.appendChild(row);
      });

    // ==========================
    // ATUALIZA TOTAIS
    // ==========================
    recPago.innerText = `R$ ${rPago.toLocaleString("pt-BR",{minimumFractionDigits:2})}`;
    recPrev.innerText = `R$ ${(rPago+rPrev).toLocaleString("pt-BR",{minimumFractionDigits:2})}`;
    despPago.innerText = `R$ ${dPago.toLocaleString("pt-BR",{minimumFractionDigits:2})}`;
    despPrev.innerText = `R$ ${(dPago+dPrev).toLocaleString("pt-BR",{minimumFractionDigits:2})}`;
    saldoPago.innerText = `R$ ${(rPago-dPago).toLocaleString("pt-BR",{minimumFractionDigits:2})}`;
    saldoPrev.innerText = `R$ ${((rPago+rPrev)-(dPago+dPrev)).toLocaleString("pt-BR",{minimumFractionDigits:2})}`;
  });
}

/* =========================
   SAVE
========================= */
function save(){
  const valTotal = Number(
    valueInput.value.replace(/\./g,"").replace(",",".")
  );

  const baseDateStr = date.value;

  /* =========================
     NÃƒO PARCELADO
  ========================= */
  if(!isParcel){
    const id = editId || Date.now().toString();

    const item = {
  id,
  name: title.value.trim(),
  value: valTotal,
  category: category.value,
  date: baseDateStr,
  type: currentType,
  paid: paid.checked,

  parcel: editingParcelData ? true : false,
parcelIndex: editingParcelData ? editingParcelData.parcelIndex : null,
parcelTotal: editingParcelData ? editingParcelData.parcelTotal : null,
parcelGroupId: editingParcelData ? editingParcelData.parcelGroupId : null
};

    const newMonthKey = getMonthKeyFromDate(item.date);

    // se estiver editando e mudou o mÃªs
    if(editId && editMonthKey && editMonthKey !== newMonthKey){
      firebase
        .database()
        .ref("finance/meses/" + editMonthKey + "/" + id)
        .remove();
    }

    firebase
      .database()
      .ref("finance/meses/" + newMonthKey + "/" + id)
      .set(item);

    closeModal();
    render();
    return;
  }

  /* =========================
     PARCELADO
  ========================= */
  const totalParcels = Number(parcelCount.value || 0);

  if(totalParcels < 2){
    alert("Informe a quantidade de parcelas");
    return;
  }

  const parcelValue = valTotal;
  const groupId = Date.now().toString();
  const baseDate = new Date(baseDateStr);

  for(let i = 0; i < totalParcels; i++){
    const d = new Date(baseDate);
    d.setMonth(d.getMonth() + i);

    const dateStr = d.toISOString().split("T")[0];
    const monthKey = getMonthKeyFromDate(dateStr);
    const id = `${groupId}_${i+1}`;

    const item = {
      id,
      name: title.value.trim(),
      value: parcelValue,
      category: category.value,
      date: dateStr,
      type: currentType,
      paid: false,

      parcel: true,
      parcelIndex: i + 1,
      parcelTotal: totalParcels,
      parcelGroupId: groupId
    };

    firebase
      .database()
      .ref("finance/meses/" + monthKey + "/" + id)
      .set(item);
  }

  closeModal();
  render();
}

/* =========================
   EDIT
========================= */
function editById(id){
  const originalMonthKey = getMonthKey();

  firebase
    .database()
    .ref("finance/meses/" + originalMonthKey + "/" + id)
    .once("value", snap=>{
      const t = snap.val();
      if(!t) return;

      title.value = t.name;
      valueInput.value = t.value.toLocaleString("pt-BR",{minimumFractionDigits:2});
      category.value = t.category;
      date.value = t.date;
      paid.checked = t.paid;
      currentType = t.type;

      // ðŸ”‘ GUARDA PARCELAMENTO (se existir)
      editingParcelData = t.parcel ? {
        parcelIndex: t.parcelIndex,
        parcelTotal: t.parcelTotal,
        parcelGroupId: t.parcelGroupId
      } : null;

      setType(currentType);
      editId = id;
      editMonthKey = originalMonthKey;
      deleteBtn.style.display = "block";
      openModal();
    });
}

/* =========================
   DELETE
========================= */
function remove(){
  if(!editId) return;
  monthRef().child(editId).remove();
  closeModal();
  render();
}

/* =========================
   MODAL
========================= */
function openModal(){
  modal.style.display="flex";
  if(editId===null){
    title.value="";
    valueInput.value="";
    category.value="";
    paid.checked=false;
    setType("income");
    
    isParcel = false;
document.getElementById("btnParcel").classList.remove("active");
document.getElementById("parcelCount").style.display = "none";
document.getElementById("parcelCount").value = "";

    const hoje=new Date();
    date.value=`${hoje.getFullYear()}-${String(hoje.getMonth()+1).padStart(2,"0")}-${String(hoje.getDate()).padStart(2,"0")}`;
    deleteBtn.style.display="none";
  }
}

function closeModal(){
  modal.style.display = "none";

  isParcel = false;
  editingParcelData = null; // ðŸ”¥ ESSENCIAL

  const btn = document.getElementById("btnParcel");
  const input = document.getElementById("parcelCount");

  btn.classList.remove("active");
  input.style.display = "none";
  input.value = "";

  editId = null;
  editMonthKey = null;
}

/* =========================
   CATEGORIAS
========================= */
function openCategoryModal(){
  document.getElementById("categoryModal").style.display="flex";
  renderCategories();
}

function closeCategoryModal(){
  document.getElementById("categoryModal").style.display="none";
}

function saveCategory(){
  const input=document.getElementById("categoryName");
  const name=input.value.trim();
  if(!name) return;

  categoriesRef().child(name).set(true);
  input.value="";
  renderCategories();
  updateCategorySelect();
}

function deleteCategory(name){
  categoriesRef().child(name).remove();
  renderCategories();
  updateCategorySelect();
}

function renderCategories(){
  const container=document.getElementById("categoryList");
  container.innerHTML="";

  categoriesRef().once("value", snap=>{
    const data = snap.val() || {};
    Object.keys(data)
      .sort((a,b)=>a.localeCompare(b,'pt-BR'))
      .forEach(c=>{
        const div=document.createElement("div");
        div.className="category-item";
        div.innerHTML=`<span>${c}</span><button onclick="deleteCategory('${c}')">âœ•</button>`;
        container.appendChild(div);
      });
  });
}

function updateCategorySelect(){
  const select = document.getElementById("category");
  select.innerHTML="";

  categoriesRef().once("value", snap=>{
    const data = snap.val() || {};
    Object.keys(data).forEach(c=>{
      const opt=document.createElement("option");
      opt.value=c;
      opt.innerText=c;
      select.appendChild(opt);
    });
  });
}


function goReports(){
  window.location.href = "relatorios.html";
}


function getMonthKeyFromDate(dateStr){
  const [year, month] = dateStr.split("-");
  return `${year}-${month}`;
}



</script>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyAd-ttfpK460D4fyfoNZY6DJRhzuItpHe0",
    authDomain: "box-financeiro.firebaseapp.com",
    databaseURL: "https://box-financeiro-default-rtdb.firebaseio.com",
    projectId: "box-financeiro",
    storageBucket: "box-financeiro.firebasestorage.app",
    messagingSenderId: "249966609723",
    appId: "1:249966609723:web:12339b100df393031ea31e"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();
  
  /* =========================
   INIT
========================= */
updateMonthLabel();
render();
updateCategorySelect();
</script>




</body>
</html>